<!DOCTYPE html>
<html lang="en">
  <head>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.5/redux.min.js'></script>
    <script src='https://unpkg.com/react@16.13.1/umd/react.development.js'></script>
    <script src='https://unpkg.com/react-dom@16.13.1/umd/react-dom.development.js'></script>
    <script src='https://unpkg.com/babel-standalone@6.26.0/babel.min.js'></script>
    <script src='https://ui.dev/goals-todos-api/index.js'></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="ui.dev redux project"
    />
    <title>lil redux project</title>
  </head>
  <body>
    <div id='app'></div>

    <script type='text/javascript'>

      function generateId () {
        return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36)
      }

      // // Library code

      // // This reducer will create dictate the shape of our state tree and handle all other reducers. This alone will be passed to our create store function
      // function createStore(reducer) {
      //     let state

      //     // this array of functions will be looped over to make state changes
      //     let listeners = []

      //     // a function to get our state
      //     const getState = () => state

      //     // a function to allow a component to both listen for state changes and remove functions from the listeners array
      //     const subscribe = listener => {
      //         listeners.push(listener)

      //         return () => {
      //             listeners = listeners.filter(l => l !== listener)
      //         }
      //     }

      //     // this dispatch function will invoke our reducer, updating the state depeding on the action object that is passed to it. It will then invoke each listener function inside the listener array notifying each component that is subscribed it that the state has changed
      //     const dispatch = action => {
      //         state = reducer(state, action)

      //         listeners.forEach(listener => listener())
      //     }

      //     // return both of these functions to be used outside of our createStore function
      //     return {
      //         getState,
      //         subscribe,
      //         dispatch
      //     }
      // }

      // App Code

      const ADD_TODO = 'ADD_TODO'
      const REMOVE_TODO = 'REMOVE_TODO'
      const TOGGLE_TODO = 'TOGGLE_TODO'
      const ADD_GOAL = 'ADD_GOAL'
      const REMOVE_GOAL = 'REMOVE_GOAL'
      const RECEIVE_DATA = 'RECEIVE_DATA'

      // Action creators

      const addTodoAction = todo => {
          return {
              type: ADD_TODO,
              todo
          }
      }

      const removeTodoAction = id => {
          return {
              type: REMOVE_TODO,
              id
          }
      }

      const toggleTodoAction = id => {
          return {
              type: TOGGLE_TODO,
              id
          }
      }

      const addGoalAction = goal => {
          return {
              type: ADD_GOAL,
              goal
          }
      }

      const removeGoalAction = id => {
          return {
              type: REMOVE_GOAL,
              id
          }
      }

      const receiveDataAction = (todos, goals) => {
        return {
          type: RECEIVE_DATA,
          todos,
          goals
        }
      }

      // Middleware functions
      const checker = store => next => action => {
        if (
          action.type === ADD_TODO &&
          action.todo.name.toLowerCase().indexOf('bitcoin') !== -1
        ) {
          return alert("Nope. That's a bad idea.")
        }

        if (
          action.type === ADD_GOAL &&
          action.goal.name.toLowerCase().indexOf('bitcoin') !== -1
        ) {
          return alert("Nope. That's a bad idea.")
        }

        return next(action)
      }

      const logger = store => next => action => {
        console.group(action.type)
        console.log('The action: ', action)
        const result = next(action)
        console.log('The new state: ', store.getState())
        console.groupEnd()

        return result
      }

      // Reducer Functions

      // this function is describing how to change the state depending on the type of action using js default parameters, if state is undefined then set it to an empty array
      const todos = (state = [], action) => {
        switch(action.type) {
            case ADD_TODO : 
              return state.concat([action.todo])
            case REMOVE_TODO : 
              return state.filter(todo => todo.id !== action.id)
            case TOGGLE_TODO : 
              return state.map(todo => todo.id !== action.id ? todo :
                  Object.assign({}, todo, {complete: !todo.complete})        
              )
            case RECEIVE_DATA :
              return action.todos
            default :
                    return state
        }
      }

      const goals = (state = [], action) => {
          switch(action.type) {
              case ADD_GOAL :
                return state.concat([action.goal])
              case REMOVE_GOAL :
                return state.filter(goal => goal.id !== action.id)
              case RECEIVE_DATA :
                return action.goals
              default : 
                  return state
          }
      }

      const loading = (state = true, action) => {
        switch(action.type) {
          case RECEIVE_DATA :
            return false
          default : 
            return state
        }
      }

      const store = Redux.createStore(Redux.combineReducers({
        todos,
        goals,
        loading
      }), Redux.applyMiddleware(checker, logger))
      </script>





    <script type='text/babel'>

      function List(props) {
          return (
            <ul>
              {props.items.map(item => (
                <li key={item.id}>
                  <span 
                    onClick={() => props.toggle && props.toggle(item.id)}
                    style={{textDecoration: item.complete ? 'line-through' : 'none'}}>
                    {item.name}
                  </span>
                  <button onClick={() => props.remove(item)}>X</button>
                </li>
              ))}
            </ul>
          )
      }

      class Todos extends React.Component {
        addItem = (e) => {
          e.preventDefault()

          return API.saveTodo(this.input.value)
            .then((todo) => {
              this.props.store.dispatch(addTodoAction(todo))
              this.input.value = ''
            })
            .catch(() => {
              alert('An error occured, try again.')
            })
        }

        removeItem = todo => {
          this.props.store.dispatch(removeTodoAction(todo.id))

          return API.deleteTodo(todo.id)
            .catch(() => {
              this.props.store.dispatch(addTodoAction(todo))
              alert('An error has occured.')
            })
        }

        toggleItem = id => {
          this.props.store.dispatch(toggleTodoAction(id))

          return API.saveTodoToggle(id)
            .catch(() => {
              this.props.store.dispatch(toggleTodoAction(id))
              alert('An error occured, try again.')
            })
        }

        render() {
          return (
            <div>
              <h1>Todos</h1>

              <input 
                type='text'
                placeholder='Add Todo'
                ref={(input) => this.input = input}
              />

              <button onClick={this.addItem}>Add Todo</button>

              <List 
                items={this.props.todos} 
                remove={this.removeItem}
                toggle={this.toggleItem}
              />
            </div>
          )
        }
      }

      class Goals extends React.Component {
        addItem = (e) => {
          e.preventDefault()

          return API.saveGoal(this.input.value)
            .then((goal) => {
              this.props.store.dispatch(addGoalAction(goal))
              this.input.value = ''
            })
            .catch(() => {
              alert('An error occured, try again.')
            })
        }

        removeItem = goal => {
          this.props.store.dispatch(removeGoalAction(goal.id))

          return API.deleteGoal(goal.id)
            .catch(() => {
              this.props.store.dispatch(addGoalAction(goal))
            })
        }

        render() {
          return (
            <div>
              <h1>Goals</h1>

              <input 
                type='text'
                placeholder='Add Goal'
                ref={input => this.input = input}
              />

              <button onClick={this.addItem}>Add Goal</button>

              <List 
                items={this.props.goals} 
                remove={this.removeItem}
              />
            </div>
          )
        }
      }

      class App extends React.Component {
        componentDidMount() {
          const { store } = this.props

          Promise.all([
            API.fetchTodos(),
            API.fetchGoals()
          ]).then(([ todos, goals ]) => {
            store.dispatch(receiveDataAction(todos, goals))
          })

          store.subscribe(() => this.forceUpdate())
        }

        render() {
          const { store } = this.props
          const { todos, goals, loading } = store.getState()

          if (loading) {
            return <h1>Loading</h1>
          }
          
          return (
            <div>
              <Todos todos={todos} store={store} />
              <Goals goals={goals} store={store} />
            </div>
          )
        }
      }

      ReactDOM.render(
        <App store={store} />,
        document.getElementById('app')
      )
      
    </script>
    
  </body>
</html>

